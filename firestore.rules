
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user's role matches a specific role.
    // IMPORTANT: This function assumes the user document exists.
    // The calling rule *must* check for existence first using exists().
    function isUserRole(userId, roleName) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role == roleName;
    }

    // Helper function to check if a user's role is one of an array of roles.
    // IMPORTANT: This function assumes the user document exists.
    // The calling rule *must* check for existence first using exists().
    function isUserRoleIn(userId, rolesArray) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role in rolesArray;
    }

    // Helper function to check if a user is the organizer of a specific event.
    // IMPORTANT: This function assumes the event document exists.
    // The calling rule *must* check for existence first using exists().
    function isEventOrganizer(userId, eventId) {
      return get(/databases/$(database)/documents/events/$(eventId)).data.organizerId == userId;
    }

    match /users/{userId} {
      allow read: if request.auth != null &&
                     (request.auth.uid == userId ||
                       (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        isUserRole(request.auth.uid, 'admin'))
                     );
      allow create: if request.auth != null &&
                      request.auth.uid == userId &&
                      request.resource.data.email == request.auth.token.email &&
                      request.resource.data.role == 'student' &&
                      request.resource.data.uid == request.auth.uid &&
                      request.resource.data.createdAt == request.time &&
                      request.resource.data.updatedAt == request.time;
      allow update: if request.auth != null &&
                       (request.auth.uid == userId ||
                         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                          isUserRole(request.auth.uid, 'admin'))
                       );
      allow delete: if request.auth != null &&
                       exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       isUserRole(request.auth.uid, 'admin'); // Only admin can delete user docs for now
    }

    match /events/{eventId} {
      allow read: if (resource.data.status == 'published') ||
                     (request.auth != null &&
                       exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       (isUserRoleIn(request.auth.uid, ['organizer', 'coadmin', 'admin']) || resource.data.organizerId == request.auth.uid)
                     );

      allow create: if request.auth != null &&
                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                      isUserRoleIn(request.auth.uid, ['organizer', 'coadmin', 'admin']) &&
                      request.resource.data.organizerId == request.auth.uid &&
                      request.resource.data.status in ['draft', 'published', 'archived', 'completed'] && // Validate status
                      request.resource.data.createdAt == request.time &&
                      request.resource.data.updatedAt == request.time &&
                      request.resource.data.name is string && request.resource.data.name.size() > 0 &&
                      request.resource.data.description is string && request.resource.data.description.size() > 0 &&
                      request.resource.data.date is timestamp &&
                      request.resource.data.venue is string && request.resource.data.venue.size() > 0 &&
                      request.resource.data.maxParticipants is number && request.resource.data.maxParticipants > 0;


      allow update: if request.auth != null &&
                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                      (
                        (resource.data.organizerId == request.auth.uid && isUserRoleIn(request.auth.uid, ['organizer', 'coadmin'])) ||
                        isUserRoleIn(request.auth.uid, ['coadmin', 'admin'])
                      ) &&
                      request.resource.data.updatedAt == request.time &&
                      request.resource.data.organizerId == resource.data.organizerId; // Prevent changing organizerId

      allow delete: if request.auth != null &&
                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                      isUserRole(request.auth.uid, 'admin');
    }

    match /registrations/{registrationId} {
      allow create: if request.auth != null &&
                      request.resource.data.studentId == request.auth.uid &&
                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                      isUserRole(request.auth.uid, 'student') &&
                      request.resource.data.status == 'pending' &&
                      request.resource.data.registeredAt == request.time &&
                      request.resource.data.eventId is string &&
                      request.resource.data.qrCodeData is string;
                      // Consider adding: && exists(/databases/$(database)/documents/events/$(request.resource.data.eventId))

      allow read: if request.auth != null && (
                    (resource.data.studentId == request.auth.uid) ||
                    (
                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                      isUserRoleIn(request.auth.uid, ['organizer', 'coadmin']) &&
                      exists(/databases/$(database)/documents/events/$(resource.data.eventId)) &&
                      isEventOrganizer(request.auth.uid, resource.data.eventId)
                    ) ||
                    (
                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                      isUserRole(request.auth.uid, 'admin')
                    )
                  );

      allow update: if request.auth != null &&
                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                      (
                        ( // Organizer/Coadmin for their event can update specific fields
                          isUserRoleIn(request.auth.uid, ['organizer', 'coadmin']) &&
                          exists(/databases/$(database)/documents/events/$(resource.data.eventId)) &&
                          isEventOrganizer(request.auth.uid, resource.data.eventId) &&
                          request.resource.keys().hasAny(['status', 'checkedInAt', 'updatedAt']) && // Allow only these fields
                          (!('status' in request.resource.data) || request.resource.data.status in ['pending', 'approved', 'rejected', 'attended']) &&
                          (!('checkedInAt' in request.resource.data) || request.resource.data.checkedInAt is timestamp || request.resource.data.checkedInAt == null)
                        ) ||
                        ( // Admin can update specific fields
                          isUserRole(request.auth.uid, 'admin') &&
                          request.resource.keys().hasAny(['status', 'checkedInAt', 'updatedAt']) &&
                          (!('status' in request.resource.data) || request.resource.data.status in ['pending', 'approved', 'rejected', 'attended']) &&
                          (!('checkedInAt' in request.resource.data) || request.resource.data.checkedInAt is timestamp || request.resource.data.checkedInAt == null)
                        )
                      ) &&
                      request.resource.data.updatedAt == request.time && // Ensure updatedAt is set for the operation
                      request.resource.data.studentId == resource.data.studentId && // Prevent changing studentId
                      request.resource.data.eventId == resource.data.eventId;       // Prevent changing eventId

      allow delete: if false; // Generally, avoid direct deletes; use a status like 'rejected' or 'cancelled'.
                               // Admins could be granted this if necessary:
                               // if request.auth != null && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && isUserRole(request.auth.uid, 'admin');
    }
  }
}
